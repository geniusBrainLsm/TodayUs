<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TodayUs 관리자 – 로봇 상점</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f5f7fb;
      --card: #ffffff;
      --primary: #2563eb;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #d1d5db;
    }
    body {
      margin: 0;
      font-family: 'Pretendard', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 32px 16px;
      background: #ffffffcc;
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }
    main {
      padding: 24px 32px 48px;
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 20px 45px -32px rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(209, 213, 219, 0.6);
    }
    .card h2 {
      margin-top: 0;
      font-size: 22px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--muted);
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; }
    .row { display: grid; gap: 16px; }
    .row.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row.three { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    button {
      cursor: pointer;
      border-radius: 12px;
      border: none;
      padding: 10px 16px;
      font-weight: 600;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #60a5fa, #2563eb);
      color: #fff;
      box-shadow: 0 10px 20px -12px rgba(37, 99, 235, 0.8);
    }
    button.secondary {
      background: rgba(37, 99, 235, 0.12);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.25);
    }
    button.danger {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(209, 213, 219, 0.6);
      text-align: left;
    }
    th {
      background: rgba(37, 99, 235, 0.08);
      font-weight: 600;
      color: #1d4ed8;
    }
    .statusChip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }
    .statusChip.active { background: rgba(16, 185, 129, 0.18); color: #047857; }
    .statusChip.inactive { background: rgba(148, 163, 184, 0.18); color: #475569; }
    .statusChip.default { background: rgba(249, 115, 22, 0.18); color: #c2410c; }
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .token-input {
      flex: 1;
      min-width: 220px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #message {
      margin-top: 12px;
      font-size: 13px;
      color: #059669;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 12px;
    }
    details[open] summary { color: #2563eb; }
    @media (max-width: 900px) {
      .row.two, .row.three { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>AI 로봇 상점 관리자</h1>
    <p style="color: var(--muted); margin: 0; font-size: 14px;">관리자 토큰을 입력하면 로봇 카탈로그와 오일을 관리할 수 있습니다.</p>
    <div class="toolbar">
      <div class="toolbar-group">
        <input id="usernameInput" placeholder="관리자 아이디" autocomplete="username" />
        <input id="passwordInput" type="password" placeholder="비밀번호" autocomplete="current-password" />
        <button class="primary" id="loginBtn">로그인</button>
      </div>
      <div class="toolbar-group">
        <input id="tokenInput" type="password" placeholder="Bearer 토큰 입력" autocomplete="off" />
        <button class="secondary" id="saveTokenBtn">토큰 저장</button>
        <button class="secondary" id="clearTokenBtn">토큰 삭제</button>
      </div>
      <button class="secondary" id="loadRobotsBtn">로봇 목록 불러오기</button>
      <span id="message"></span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>로봇 목록</h2>
      <div id="robotsContainer">관리자 로그인 또는 토큰 입력 후 “로봇 목록 불러오기”를 눌러주세요.</div>
    </section>

    <section class="card">
      <h2>로봇 등록</h2>
      <form id="createRobotForm" class="row" autocomplete="off">
        <div class="row two">
          <div>
            <label>코드 (영문/숫자)
              <input name="code" required />
            </label>
          </div>
          <div>
            <label>이름
              <input name="name" required />
            </label>
          </div>
        </div>
        <div class="row two">
          <div>
            <label>가격 (OIL)
              <input name="priceOil" type="number" min="0" required />
            </label>
          </div>
          <div>
            <label>대표 색상 (HEX)
              <input name="themeColorHex" placeholder="#FF8AB8" />
            </label>
          </div>
        </div>
        <div class="row two">
          <div>
            <label>목업 이미지 URL
              <input name="imageUrl" placeholder="https://..." />
            </label>
          </div>
          <div>
            <label>스플래시 이미지 URL
              <input name="splashImageUrl" placeholder="https://..." />
            </label>
          </div>
        </div>
        <div>
          <label>태그라인
            <input name="tagline" placeholder="짧은 소개 문구" />
          </label>
        </div>
        <div>
          <label>로봇 설명</label>
          <textarea name="description" placeholder="로봇 캐릭터 설명"></textarea>
        </div>
        <div class="row two">
          <div>
            <label>챗봇 지침 (사용자에게 보여줄 안내)</label>
            <textarea name="chatUserGuidance" placeholder="응답 톤, 구조 등을 bullet로 작성"></textarea>
          </div>
          <div>
            <label>일기 코멘트 지침</label>
            <textarea name="commentUserGuidance" placeholder="코멘트 길이, 톤 등"></textarea>
          </div>
        </div>
        <div class="row three">
          <div>
            <label>Chat Max Tokens
              <input name="chatMaxTokens" type="number" min="0" placeholder="예: 500" />
            </label>
          </div>
          <div>
            <label>Chat Temperature
              <input name="chatTemperature" type="number" min="0" max="2" step="0.05" placeholder="예: 0.7" />
            </label>
          </div>
          <div>
            <label>Comment Max Tokens
              <input name="commentMaxTokens" type="number" min="0" placeholder="예: 200" />
            </label>
          </div>
        </div>
        <div class="row two">
          <div>
            <label>Comment Temperature
              <input name="commentTemperature" type="number" min="0" max="2" step="0.05" placeholder="예: 0.6" />
            </label>
          </div>
          <div>
            <label>Preview 메시지
              <input name="previewMessage" placeholder="홈/상점에서 보여줄 한 줄" />
            </label>
          </div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="flex:0 0 auto;"><input type="checkbox" name="defaultRobot" /> 기본 로봇으로 지정</label>
          <label style="flex:0 0 auto;"><input type="checkbox" name="active" checked /> 판매/사용 가능</label>
        </div>
        <div style="margin-top:16px; display:flex; gap:12px;">
          <button type="submit" class="primary">로봇 등록</button>
          <button type="reset" class="secondary">초기화</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>오일 관리</h2>
      <form id="oilForm" class="row two" autocomplete="off">
        <div>
          <label>사용자 ID
            <input name="userId" type="number" min="1" required />
          </label>
        </div>
        <div>
          <label>오일 수량 (+ 충전, - 차감)
            <input name="amount" type="number" required />
          </label>
        </div>
        <div>
          <label>감소 여부
            <select name="deduct">
              <option value="false">증정 (플러스)</option>
              <option value="true">차감 (마이너스)</option>
            </select>
          </label>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button type="submit" class="primary">적용</button>
        </div>
      </form>
    </section>
  </main>

  <template id="robotRowTemplate">
    <details class="robot-panel" open>
      <summary></summary>
      <form class="robot-form row" autocomplete="off"></form>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button type="submit" class="primary">저장</button>
        <button type="button" class="secondary">활성 토글</button>
        <button type="button" class="danger">삭제</button>
      </div>
    </details>
  </template>

  <script>
    const tokenKey = 'todayus_admin_token';
    let authToken = localStorage.getItem(tokenKey) || '';

    const tokenInput = document.getElementById('tokenInput');
    const saveTokenBtn = document.getElementById('saveTokenBtn');
    const loadRobotsBtn = document.getElementById('loadRobotsBtn');
    const messageSpan = document.getElementById('message');
    const robotsContainer = document.getElementById('robotsContainer');
    const createRobotForm = document.getElementById('createRobotForm');
    const oilForm = document.getElementById('oilForm');

    if (authToken) {
      tokenInput.value = authToken;
    }

    const robotTemplate = document.getElementById('robotRowTemplate');

    function showMessage(text, color = '#059669') {
      messageSpan.textContent = text;
      messageSpan.style.color = color;
      if (text) {
        setTimeout(() => {
          if (messageSpan.textContent === text) {
            messageSpan.textContent = '';
          }
        }, 4000);
      }
    }

    function requireToken() {
      if (!authToken) {
        showMessage('먼저 관리자 토큰을 입력하세요.', '#b91c1c');
        throw new Error('missing token');
      }
    }

    async function apiFetch(path, options = {}) {
      requireToken();
      const res = await fetch(path, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          Authorization: Bearer ,
          ...(options.headers || {}),
        },
      });
      if (!res.ok) {
        const body = await res.text();
        const errorText = body ? ${res.status} :  : ${res.status} ;
        throw new Error(errorText);
      }
      const text = await res.text();
      return text ? JSON.parse(text) : {};
    }

    function renderRobots(overview) {
      if (!overview.robots || overview.robots.length === 0) {
        robotsContainer.innerHTML = '<p>등록된 로봇이 없습니다.</p>';
        return;
      }
      const fragment = document.createDocumentFragment();
      overview.robots.forEach((robot) => {
        const clone = robotTemplate.content.cloneNode(true);
        const details = clone.querySelector('details');
        const summary = clone.querySelector('summary');
        const form = clone.querySelector('form');
        const saveBtn = clone.querySelector('.primary');
        const toggleBtn = clone.querySelector('.secondary');
        const deleteBtn = clone.querySelector('.danger');

        summary.innerHTML = # ·  <span class="statusChip "></span> + (robot.defaultRobot ? ' <span class="statusChip default">DEFAULT</span>' : '');

        form.innerHTML = 
          <div class="row two">
            <div>
              <label>코드
                <input name="code" value="" required />
              </label>
            </div>
            <div>
              <label>이름
                <input name="name" value="" required />
              </label>
            </div>
          </div>
          <div class="row two">
            <div>
              <label>가격(OIL)
                <input name="priceOil" type="number" min="0" value="" required />
              </label>
            </div>
            <div>
              <label>대표 색상 HEX
                <input name="themeColorHex" value="" />
              </label>
            </div>
          </div>
          <div class="row two">
            <div>
              <label>목업 이미지 URL
                <input name="imageUrl" value="" />
              </label>
            </div>
            <div>
              <label>스플래시 이미지 URL
                <input name="splashImageUrl" value="" />
              </label>
            </div>
          </div>
          <div>
            <label>태그라인
              <input name="tagline" value="" />
            </label>
          </div>
          <div>
            <label>로봇 설명
              <textarea name="description"></textarea>
            </label>
          </div>
          <div class="row two">
            <div>
              <label>응답 안내
                <textarea name="chatUserGuidance"></textarea>
              </label>
            </div>
            <div>
              <label>코멘트 안내
                <textarea name="commentUserGuidance"></textarea>
              </label>
            </div>
          </div>
          <div class="row three">
            <div>
              <label>Chat Max Tokens
                <input name="chatMaxTokens" type="number" value="" />
              </label>
            </div>
            <div>
              <label>Chat Temperature
                <input name="chatTemperature" type="number" step="0.05" value="" />
              </label>
            </div>
            <div>
              <label>Comment Max Tokens
                <input name="commentMaxTokens" type="number" value="" />
              </label>
            </div>
          </div>
          <div class="row two">
            <div>
              <label>Comment Temperature
                <input name="commentTemperature" type="number" step="0.05" value="" />
              </label>
            </div>
            <div style="display:flex; gap:16px; align-items:center; padding-top:12px;">
              <label><input type="checkbox" name="defaultRobot"  /> 기본</label>
              <label><input type="checkbox" name="active"  /> 판매/사용</label>
            </div>
          </div>;

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          try {
            const payload = formToPayload(new FormData(form));
            await apiFetch(/api/admin/store/robots/, {
              method: 'PUT',
              body: JSON.stringify(payload),
            });
            showMessage('로봇 정보가 저장되었습니다.');
            await loadRobots();
          } catch (err) {
            console.error(err);
            showMessage(저장 실패: , '#b91c1c');
          }
        });

        toggleBtn.textContent = robot.active ? '비활성화' : '활성화';
        toggleBtn.addEventListener('click', async () => {
          try {
            const payload = formToPayload(new FormData(form));
            payload.active = !robot.active;
            await apiFetch(/api/admin/store/robots/, {
              method: 'PUT',
              body: JSON.stringify(payload),
            });
            showMessage(로봇이  되었습니다.);
            await loadRobots();
          } catch (err) {
            console.error(err);
            showMessage(상태 변경 실패: , '#b91c1c');
          }
        });

        deleteBtn.addEventListener('click', async () => {
          if (!confirm(${robot.name} 로봇을 삭제할까요?)) return;
          try {
            await apiFetch(/api/admin/store/robots/, {
              method: 'DELETE',
            });
            showMessage('로봇이 삭제되었습니다.');
            await loadRobots();
          } catch (err) {
            console.error(err);
            showMessage(삭제 실패: , '#b91c1c');
          }
        });

        fragment.appendChild(clone);
      });
      robotsContainer.innerHTML = '';
      robotsContainer.appendChild(fragment);
    }

    function formToPayload(formData) {
      const payload = {};
      formData.forEach((value, key) => {
        if (['defaultRobot', 'active'].includes(key)) {
          payload[key] = value === 'on';
        } else if (/MaxTokens$/i.test(key) || key === 'priceOil') {
          payload[key] = value ? Number(value) : null;
        } else if (/Temperature$/i.test(key)) {
          payload[key] = value ? Number(value) : null;
        } else {
          payload[key] = value?.toString() ?? null;
        }
      });
      return payload;
    }

    async function loadRobots() {
      try {
        const overview = await apiFetch('/api/admin/store/robots');
        renderRobots(overview);
        showMessage('로봇 목록을 불러왔습니다.');
      } catch (err) {
        console.error(err);
        showMessage(로봇 정보를 불러오지 못했습니다: , '#b91c1c');
      }
    }

    saveTokenBtn.addEventListener('click', () => {
      authToken = tokenInput.value.trim();
      localStorage.setItem(tokenKey, authToken);
      showMessage('토큰을 저장했습니다.');
    });

    loadRobotsBtn.addEventListener('click', () => {
      authToken = tokenInput.value.trim();
      localStorage.setItem(tokenKey, authToken);
      loadRobots();
    });

    createRobotForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(createRobotForm);
      const payload = formToPayload(formData);
      try {
        await apiFetch('/api/admin/store/robots', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        createRobotForm.reset();
        showMessage('새 로봇이 등록되었습니다.');
        await loadRobots();
      } catch (err) {
        console.error(err);
        showMessage(등록 실패: , '#b91c1c');
      }
    });

    oilForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(oilForm);
      const userId = formData.get('userId');
      const amount = Number(formData.get('amount'));
      const deduct = formData.get('deduct') === 'true';
      if (!userId) {
        showMessage('사용자 ID를 입력하세요.', '#b91c1c');
        return;
      }
      try {
        await apiFetch(/api/admin/store/users//oil, {
          method: 'POST',
          body: JSON.stringify({ amount: Math.abs(amount), deduct }),
        });
        showMessage('오일 조정이 완료되었습니다.');
        oilForm.reset();
      } catch (err) {
        console.error(err);
        showMessage(오일 조정 실패: , '#b91c1c');
      }
    });
  </script>
</body>
</html>









